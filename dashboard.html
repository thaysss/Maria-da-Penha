<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>SOS BackOffice - Monitoramento em Tempo Real</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; height: 100vh; }
        
        /* Barra Lateral de Alertas */
        #sidebar {
            width: 350px;
            background-color: #f4f4f4;
            border-right: 2px solid #ddd;
            display: flex;
            flex-direction: column;
        }
        
        #sidebar-header {
            background-color: #c0392b; /* Vermelho Alerta */
            color: white;
            padding: 20px;
            text-align: center;
        }

        #alert-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .alert-card {
            background: white;
            border-left: 5px solid #c0392b;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            animation: flash 1s infinite; /* Efeito visual de perigo */
        }
        
        .alert-card.acknowledged {
            border-left-color: #27ae60;
            animation: none;
        }

        /* O Mapa */
        #map { flex: 1; }

        @keyframes flash {
            0% { background-color: white; }
            50% { background-color: #ffe6e6; }
            100% { background-color: white; }
        }
    </style>
</head>
<body>

    <div id="sidebar">
        <div id="sidebar-header">
            <h2>MURALHA DIGITAL</h2>
            <p>Monitoramento Ao Vivo</p>
        </div>
        <div id="alert-list">
            <p style="text-align: center; color: #777; margin-top: 20px;">Aguardando ocorr√™ncias...</p>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- A. INICIALIZAR O MAPA ---
        // Centralizado em Aracaju/SE (Baseado no endere√ßo da 3Tecnos nos docs)
        const map = L.map('map').setView([-10.9472, -37.0731], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // √çcone personalizado para o Alerta
        const panicIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/1036/1036006.png', // Exemplo de √≠cone de sirene
            iconSize: [40, 40],
        });

        // --- B. CONEX√ÉO WEBSOCKET (O C√©rebro) ---
        // Conecta na API Python que criamos no passo anterior
        const socket = new WebSocket("ws://localhost:8000/ws/monitor");

        const alertList = document.getElementById('alert-list');
        let isFirstAlert = true;

        socket.onopen = function(e) {
            console.log("[Conectado] Monitoramento ativo na Central");
        };

        // --- C. RECEBER O ALERTA (Real-Time) ---
        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            console.log("Novo dado recebido:", data);

            if (data.type === "NEW_PANIC_ALERT") {
                handlePanicAlert(data);
            } else if (data.type === "STATUS_UPDATE") {
                console.log("Viatura atualizou status:", data);
                // Aqui voc√™ atualizaria a cor do √≠cone para verde (em atendimento)
            }
        };

        socket.onclose = function(event) {
            if (event.wasClean) {
                console.log(`[Desconectado] C√≥digo: ${event.code}`);
            } else {
                console.log('[Queda de Conex√£o] O servidor caiu.'); // Tentar reconectar aqui em produ√ß√£o
            }
        };

        // --- D. L√ìGICA DE EXIBI√á√ÉO ---
        function handlePanicAlert(alert) {
            // 1. Limpar mensagem de "Aguardando"
            if (isFirstAlert) {
                alertList.innerHTML = '';
                isFirstAlert = false;
            }

            // 2. Adicionar Marcador no Mapa
            const marker = L.marker([alert.location.lat, alert.location.lng], {icon: panicIcon})
                .addTo(map)
                .bindPopup(`<b>SOCORRO!</b><br>V√≠tima ID: ${alert.victim_id}<br>${alert.time}`)
                .openPopup();

            // Centralizar o mapa no incidente
            map.flyTo([alert.location.lat, alert.location.lng], 16);

            // 3. Adicionar Card na Lateral
            const card = document.createElement('div');
            card.className = 'alert-card';
            card.innerHTML = `
                <h3>üö® P√ÇNICO ACIONADO</h3>
                <p><strong>V√≠tima ID:</strong> ${alert.victim_id}</p>
                <p><strong>Hor√°rio:</strong> ${alert.time}</p>
                <button onclick="dispatchUnit(${alert.incident_id}, this)">Despachar Viatura</button>
            `;
            alertList.prepend(card);

            // 4. Tocar Som de Alerta (Opcional)
            // const audio = new Audio('sirene.mp3');
            // audio.play();
        }

        // Fun√ß√£o simulada de despacho
        function dispatchUnit(id, btnElement) {
            alert("Viatura mais pr√≥xima notificada!");
            // Visualmente marca como atendido
            btnElement.parentElement.classList.add('acknowledged');
            btnElement.innerText = "Viatura a Caminho";
            btnElement.disabled = true;
            
            // Aqui enviaria um POST para a API avisando que a ocorr√™ncia foi aceita
        }
    </script>
</body>
</html>